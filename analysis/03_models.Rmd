---
title: "Models"
author: "Suparna Chaudhry and Andrew Heiss"
date: "Last run: `r format(Sys.time(), '%F')`"
output: 
  html_document:
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)
knit_print.data.frame <- function(x, ...) {
  res <- paste(c('', '', kable_styling(kable(x, booktabs = TRUE))), collapse = '\n')
  asis_output(res)
}

registerS3method("knit_print", "data.frame", knit_print.data.frame)
registerS3method("knit_print", "grouped_df", knit_print.data.frame)

knitr::opts_chunk$set(fig.retina = 3,
                      tidy.opts = list(width.cutoff = 120),  # For code
                      options(width = 90),  # For output
                      fig.asp = 0.618, fig.width = 7, 
                      fig.align = "center", out.width = "85%")

options(dplyr.summarise.inform = FALSE,
        knitr.kable.NA = "")
```

```{r load-libraries-data, message=FALSE, warning=FALSE}
library(tidyverse)
library(targets)
library(broom)
library(broom.mixed)
library(here)
library(brms)
library(lme4)
library(modelsummary)

CHAINS <- 4
ITER <- 2000
WARMUP <- 1000
BAYES_SEED <- 1234
options(mc.cores = parallel::detectCores())  # Use all cores

# Generated via random.org
set.seed(9936)

# Load data
# Need to use this withr thing because tar_read() and tar_load() need to see the
# _targets folder in the current directory, but this .Rmd file is in a subfolder
withr::with_dir(here::here(), {
  source(tar_read(plot_funs))
  
  canary <- tar_read(panel_done_trimmed)
  canary_lagged <- tar_read(panel_lagged_trimmed)
})
```

TODO: (from the envelope on my desk):

1. Null model: PTS ~ (1 | year) + (1 | country)
2. PTS ~ repression + (1 | year) + (1 | country)
3. PTS + repression within/between + (1 | year) + (1 | country)
4. Fuller models with more controls - region dummies vs. (1 | region / country)
5. Switch to ordered logit
6. Logs and SNMM combination
7. Make sure selection on observables is okay
8. IPW?


TODO:

- Causal model
- Run actual models
- Show marginal effects - change in predicted probability of PTS levels as CS restriction changes
- Use matching (https://cran.r-project.org/web/packages/PanelMatch/vignettes/using_panelmatch.html), IPW (BlackwellGlynn:2018) to isolate effect
- Careful selection of confounders, following BellemareMasakiPepinsky:2017 and Samii:2016
- Use MSMs or whatever BlackwellGlynn:2018 suggest?


- Use four versions of each coefficient - within/between year/country
- When interpreting, focus on within (moving up/down from average level). Within country = in a typical country, the effect/association of x on y (i.e. increasing 1 more above average in a normal country is associated with β change in Y). Within year = in a typical year, the effect association of x on y (i.e. increasing 1 more above average in a given year is associated with a β change in Y)

- Within country = increasing 1 unit of X above the average in a typical country is associated with β change in Y
- Within year = increasing 1 unit of X above the average during a typical year is associated with a β change in Y
- Between country = countries with higher average X are associated with a β higher level of Y 
- Between country = years with higher average X are associated with a β higher level of Y 

> I'd just go with the basic one unit change marginal effects language. You can talk about it in ranges too since the groups are actually meaningful. The effect of X on Y was twice as great in 2012 as it was in 2008 or something.
https://twitter.com/DavidPoe223/status/1236864935537278976

> When you add a 1 inside (1 + year|continent/country), you are essentially allowing the countries to have their intercepts specified as "global intercept + country-specific displacement from global intecept + continent-specific displacement from global intercept".
https://twitter.com/IsabellaGhement/status/1236849235275829248

> Yes, that model would allow temporal trends specific to each country, while also estimating how trends differ across countries and also across continents relative to the trend for a "typical" country in a "typical" continent (all else being equal).
https://twitter.com/IsabellaGhement/status/1236850446016188416

# Within/between effects (aka Mundlak device)
PTS ~ 1 + CS_repress_demeaned + CS_repress_mean + controls_demeaned + controls_meaned +
  year +  # Allow for year global trend
  (1 + year | country)  # Random country intercepts

https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification

https://rpubs.com/jebyrnes/causal_mods

http://methods.johndavidpoe.com/2019/02/05/my-talk-at-iu/


**I ran all these models in March 2020 pre-pandemic and I have no idea why??**

```{r}
canary_demeaned <- canary_lagged %>% 
  mutate(gwcode = as.factor(gwcode)) %>% 
  group_by(gwcode) %>% 
  mutate_at(vars(v2csreprss, v2x_polyarchy, gdpcap_log),
            list(between = ~mean(., na.rm = TRUE),  # Between, for countries
                 within = ~. - mean(., na.rm = TRUE)))  # Within, for countries

model_asdf <- lmer(PTS_lead1 ~  # Overall terror/repression level
                     v2csreprss_within + v2csreprss_between +  # Civil society repression
                     v2x_polyarchy_within + v2x_polyarchy_between +  # Democracy
                     gdpcap_log_within + gdpcap_log_between +  # GDP per capita
                     armed_conflict +  # Government involved in conflict with 25+ battle deaths
                     splines::bs(year) +  # Non-linear year trend
                     (1 + v2csreprss_within | gwcode) +  # Random slopes for within CS repression
                     # (1 + v2csreprss_within | region/gwcode) +  # Random slopes for within CS repression
                     (1 + v2csreprss_between | gwcode),  # Random slopes for within CS repression
                     # (1 + v2csreprss_between | region/gwcode),  # Random slopes for between CS repression
                   data = canary_demeaned)

# modelsummary(list(model_asdf))
tidy(model_asdf, effects = "fixed")
# coef(model_asdf)$`gwcode` %>% rownames_to_column() %>% as_tibble() %>% head()
# coef(model_asdf)$region %>% rownames_to_column() %>% as_tibble()
```



```{r}
model_lag1 <- lm(PTS_lead1 ~ barriers_total + v2x_polyarchy + gdpcap_log + as.factor(year),
                 data = canary_lagged)

modelx_lag1 <- lm(PTS_lead1 ~ v2csreprss + v2x_polyarchy + gdpcap_log + as.factor(year),
                 data = canary_lagged)

modelxx_lag1 <- lm(PTS_lead1 ~ v2csreprss,
                   data = canary_lagged)

modelsummary(list(model_lag1, modelx_lag1, modelxx_lag1),
             coef_omit = "^as.factor",
             stars = TRUE, gof_omit = "IC|F|Log.|R2$") %>% 
  row_spec(10, extra_css = "border-bottom: 2px solid")
```

**¿What even is this stuff?**

```{r eval=FALSE}
thing1 <- brm(
  bf(PTS_lead1 ~ v2csreprss + v2x_polyarchy + region + gdpcap_log + 
       year + (1 + year | gwcode)),
  family = gaussian, inits = 0,
  control = list(adapt_delta = 0.99),
  data = canary_lagged %>% select(PTS_lead1, v2csreprss, v2x_polyarchy, 
                                  region, gdpcap_log, year, gwcode),
  prior = c(set_prior("normal(0, 10)", class = "Intercept"),
            set_prior("normal(0, 2.5)", class = "b"),
            set_prior("normal(0, 2.5)", class = "sd")),
  chains = CHAINS, iter = 8000, warmup = WARMUP, seed = BAYES_SEED,
  file = here("analysis", "cache", "thing_8000")
)

tidy(thing1)
tidy(thing)

# Random intercepts & random slopes?
lmer(outcome ~ explanatory + controls + (1 | year) + (1 | countrycode))

# Partial pooling?
lmer(outcome ~ explanatory + controls + (1 + year | countrycode))

brm(bf(outcome ~ explanatory + controls + year + (1 + year | countrycode)))


PTS ~ CS_repress + controls + as.factor(year) + 
  (1 + as.factor(year) | countrycode) + (1 + region | )

# Super rich model with country, year, and region effects - information flows through the whole structure: https://twitter.com/statwonk/status/1236794927683698688
PTS ~ CS_repress + controls +
  (1 | continent/country/year)

# Effect of each year and also each country has its own year effects:
(1 | year) + (1 | country) + (1 | year:country)

# Slopes vs. shocks
# https://twitter.com/statwonk/status/1236785673853681664
as.factor(year) + (1 | year) + (1 | country) + (1 | year:country)



PTS ~ CS_repress + controls +
  year + (1 + year | country) +  # Random year slopes within countries
  (1 | continent/country/year)  # Random intercepts nested inside continent/country/year


PTS ~ CS_repress + controls +
  year + (1 + year | country) +  # Random year slopes within countries
  (1 | continent/country/year)  # Random intercepts nested inside continent/country/year


# Nested continent/country effects
PTS ~ CS_repress + controls +
  (1 | year) +  # Allow for year shocks
  (1 + year | continent / country)  # Random nested continent/country intercepts

# Within/between effects (aka Mundlak device)
PTS ~ 1 + CS_repress_demeaned + CS_repress_mean + controls_demeaned + controls_meaned +
  year +  # Allow for year global trend
  (1 + year | continent / country)  # Random nested continent/country intercepts

PTS ~ CS_repress + controls +
  year + (1 | year) +  # YOLO trend + shocks
  (1 + year | continent / country)  # Random nested continent/country intercepts


# Just country effects
PTS ~ CS_repress + controls +
  (1 | year) +  # Allow for year shocks
  (1 + year | country)  # Random nested country intercepts

PTS ~ CS_repress + controls +
  year +  # Allow for year global trend
  (1 + year | country)  # Random nested country intercepts

PTS ~ CS_repress + controls +
  year + (1 | year) +  # YOLO trend + shocks
  (1 + year | country)  # Random nested country intercepts




get_prior(bf(PTS_lead1 ~ v2csreprss + v2x_polyarchy + region + gdpcap_log + (1 | year) + (1 | gwcode)),
  family = gaussian,
  data = canary_lagged)

diff_cs_pts <- brm(
  bf(v2csreprss ~ 0 + PTS_factor, sigma ~ 0 + PTS_factor),
  family = student, 
  data = filter(canary, year == 2010) %>% select(v2csreprss, PTS_factor),
  prior = c(
    # Set group mean prior
    set_prior("normal(0, 1)", class = "b", lb = -4, ub = 4),
    # Set group variance priors. We keep the less informative cauchy(0, 1).
    set_prior("cauchy(0, 1)", class = "b", dpar = "sigma"),
    set_prior("exponential(1.0/29)", class = "nu")
  ),
  chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,
  file = here("analysis", "cache", "diff_cs_pts")
)
```

